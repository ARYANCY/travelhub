<% layout('/layouts/boilerplate') %>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script>
<body>
    <% if (success && success.length) { %>
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        <%= success %>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="close"></button>
    </div>
    <% } %>
    <% if (error && error.length) { %>
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        <%= error %>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="close"></button>
    </div>
    <% } %>

    <h1>DETAILS LISTINGS</h1>
    <form action="/" method="get">
        <button class="btn btn-outline-success w-25 mb-4" type="submit">HOME</button>
    </form>
    <div class="card-grid" style="display: flex;flex-direction: column;">
                <img class="card-img-top rounded mx-auto d-block" src="<%= showListings.image.url %>" alt="Listing Image"/>
                <div class="card-body" >
                        <h4 class="card-title"><%= showListings.title %></h4>
                        <p class="card-text"><%= showListings.description %></p>
                        <p class="card-text">&#8377 <%= showListings.price.toLocaleString("en-IN") %></p>
                        <p class="card-text">loc: <%= showListings.location %> , <%= showListings.country %></p>
                        <% if(currentUser && currentUser._id.equals(showListings.owner._id)){ %>
                        <div style="display: flex;flex-direction: row;justify-content: space-between;">
                            <form action="/listings/<%=  showListings.id %>/edit" method="get">
                                <button class="btn btn-primary mt-4  my-5" type="submit" style="background-color: blue;"> UPDATE</button>
                            </form>
                            <form action="/listings/<%=  showListings.id %>?_method=DELETE" method="post">
                                <button class="btn btn-primary mt-4" type="submit" style="background-color: red;" onclick="return confirm('Are you sure you want to delete this listing?');"> DELETE</button>
                            </form>
                        </div>
                        <% } %>
                        <hr/>
                        <% if(currentUser){ %>
                        <div class="Review">
                            <h4>Leave a Review</h4>
                            <form action="/listings/<%=showListings.id %>/reviews" method="post" class="needs-validation" novalidate >
                            <div class="mb-3 mt-3">
                                <label for="rating" class="form-label">Rating</label>
                                <div class="rating">
                                    <input type="radio" id="star-5" name="review[rating]" value="5">
                                    <label for="star-5">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                                            <path pathLength="360" d="M12,17.27L18.18,21L16.54,13.97L22,9.24L14.81,8.62L12,2L9.19,8.62L2,9.24L7.45,13.97L5.82,21L12,17.27Z"></path>
                                        </svg>
                                    </label>

                                    <input type="radio" id="star-4" name="review[rating]" value="4">
                                    <label for="star-4">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                                            <path pathLength="360" d="M12,17.27L18.18,21L16.54,13.97L22,9.24L14.81,8.62L12,2L9.19,8.62L2,9.24L7.45,13.97L5.82,21L12,17.27Z"></path>
                                        </svg>
                                    </label>

                                    <input type="radio" id="star-3" name="review[rating]" value="3">
                                    <label for="star-3">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                                            <path pathLength="360" d="M12,17.27L18.18,21L16.54,13.97L22,9.24L14.81,8.62L12,2L9.19,8.62L2,9.24L7.45,13.97L5.82,21L12,17.27Z"></path>
                                        </svg>
                                    </label>

                                    <input type="radio" id="star-2" name="review[rating]" value="2">
                                    <label for="star-2">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                                            <path pathLength="360" d="M12,17.27L18.18,21L16.54,13.97L22,9.24L14.81,8.62L12,2L9.19,8.62L2,9.24L7.45,13.97L5.82,21L12,17.27Z"></path>
                                        </svg>
                                    </label>

                                    <input type="radio" id="star-1" name="review[rating]" value="1">
                                    <label for="star-1">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                                            <path pathLength="360" d="M12,17.27L18.18,21L16.54,13.97L22,9.24L14.81,8.62L12,2L9.19,8.62L2,9.24L7.45,13.97L5.82,21L12,17.27Z"></path>
                                        </svg>
                                    </label>
                                </div>
                            </div>


                                    <label for="review" class="form-label">Comment</label>
                                    <div class="rev">
                                        <textarea class="form-control" name="review[comment]" id="comment" cols="50" rows="10" required></textarea>
                                              <div class="invalid-feedback">
                                                    Please enter a valid review
                                                </div> 
        

                                </div>
                                <button  class="btn btn-primary mt-4" type="submit" style="background-color: black;">SUBMIT</button>
                                 </form>
                             </div>
                        <% } %>

                </div>
    </div>

    <hr/>

    <div class="detail-reviews">
        <h3>All Reviews</h3>
        <div class="container my-4">
            <div class="row g-3">
                <div class="col-md-6">
                    <div class="card shadow-sm h-100 text-center">
                        <div class="card-body d-flex flex-column justify-content-center align-items-center">
                        <p class="h6 mb-2">Rating</p>
                        <div class="d-flex align-items-center mb-2">
                            <% 
                            let ratings = showListings.Reviews.map(r => r.rating);
                            let avgRating = ratings.length > 0 ? ratings.reduce((a,b)=>a+b,0)/ratings.length : 0;
                            %>
                            <% for(let i=1; i<=5; i++) { %>
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" 
                                class="me-1" width="24" height="24" 
                                fill="<%= i <= avgRating ? '#eecb08' : '#e0e0e0' %>">
                                <path d="M17.56 21a1 1 0 0 1-.46-.11L12 18.22l-5.1 2.67a1 1 0 0 1-1.45-1.06l1-5.63-4.12-4a1 1 0 0 1-.25-1 1 1 0 0 1 .81-.68l5.7-.83 2.51-5.13a1 1 0 0 1 1.8 0l2.54 5.12 5.7.83a1 1 0 0 1 .81.68 1 1 0 0 1-.25 1l-4.12 4 1 5.63a1 1 0 0 1-.4 1 1 1 0 0 1-.62.18z"></path>
                            </svg>
                            <% } %>
                        </div>
                        <p class="h5 mb-0"><%= avgRating.toFixed(1) %></p>
                        </div>
                    </div>
                </div>

                <div class="col-md-6">
                <div class="card shadow-sm h-100 text-center">
                    <div class="card-body d-flex flex-column justify-content-center align-items-center">
                    <p class="h6 mb-2">Reviews</p>
                    <div class="d-flex align-items-center mb-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="#0d6efd" class="me-1" viewBox="0 0 24 24">
                        <path d="M2 21h4V9H2v12zm20-11c0-1.1-.9-2-2-2h-6.31l.95-4.57.03-.32a1 1 0 0 0-.29-.7L13.17 2 7.59 7.59C7.22 7.95 7 8.45 7 9v9c0 1.1.9 2 2 2h7c.83 0 1.54-.5 1.84-1.22l3.02-7.05c.09-.23.14-.47.14-.73v-1.8z"/>
                        </svg>
                        <% 
                        let count = showListings.Reviews.length;
                        let formattedCount = count >= 1000 ? (count / 1000).toFixed(1) + 'k' : count;
                        %>
                        <p class="h5 mb-0"><%= formattedCount %></p>
                    </div>
                    </div>
                </div>
                </div>

            </div>
        </div>

        <div class="container my-5">
        <% showListings.Reviews.slice().reverse().forEach(review => { %>
            <div class="card mb-4 shadow-sm border-0">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-2">
                <div class="d-flex align-items-center">
                    <% for (let i = 1; i <= 5; i++) { %>
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" 
                            width="22" height="22" class="star me-1" 
                            fill="<%= i <= review.rating ? '#eecb08' : '#e0e0e0' %>">
                            <path pathLength="360" d="M12,17.27L18.18,21L16.54,13.97L22,9.24L14.81,8.62L12,2L9.19,8.62L2,9.24L7.45,13.97L5.82,21L12,17.27Z"></path>
                        </svg>

                    <% } %>
                </div>
                <small class="text-primary fst-italic">
                    <%= review.createdAt ? review.createdAt.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) : "Unknown date" %>
                </small>
                </div>

                <p class="card-text text-secondary mb-3" style="line-height: 1.6;">
                <%= review.comment || "No comment provided." %>
                </p>

                <div class="d-flex justify-content-between align-items-center">
                <span class="text-muted fw-medium">
                    — <%= review.author ? review.author.username : "Anonymous" %>
                </span>
                <% if(currentUser && review.author && currentUser._id.equals(review.author._id)) { %>
                    <form method="post" action="/listings/<%= showListings.id %>/reviews/<%= review._id %>?_method=DELETE" class="m-0">
                    <button type="submit" class="btn btn-sm btn-outline-danger">
                        Delete
                    </button>
                    </form>
                <% } %>
                </div>
            </div>
            </div>
        <% }); %>
        </div>
    </div>

    </br>

    <div class="map-section">
        <h3>Where you'll be</h3>
        <p><%= showListings.location %> , <%= showListings.country %></p>
        <div id="map" style="height: 400px;border-radius: 20px; margin-bottom: 30px;"></div>
    </div>
     
</body>
<script src="/js/script.js"></script>


<script>
var lat = parseFloat("<%= showListings.Mapcoordinates?.latitude ?? 51.5 %>");
var lng = parseFloat("<%= showListings.Mapcoordinates?.longitude ?? -0.09 %>");

var map = L.map('map').setView([lat, lng], 13);

L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
}).addTo(map);

var marker = L.marker([lat, lng]).addTo(map);
marker.bindPopup("<b><%= showListings.title %></b>").openPopup();

var popup = L.popup();

function onMapClick(e) {
    popup
        .setLatLng(e.latlng)
        .setContent("You clicked the map at " + e.latlng.toString())
        .openOn(map);
}

map.on('click', onMapClick);
</script>
